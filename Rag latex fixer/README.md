# RAG-based LaTeX Style & Layout Fixer

An intelligent system for automatically detecting and fixing LaTeX style, layout, and formatting issues using **Retrieval-Augmented Generation (RAG)**. Perfect for fixing LaTeX documents generated by APIs or converters that have placement, centering, and structural problems.

## ğŸ¯ What It Fixes

Unlike traditional LaTeX error fixers that focus on compilation errors, this system specializes in **style and layout issues**:

### âœ… **Formatting Issues**
- **Author blocks not centered** â†’ Applies proper centering and format-specific commands
- **Tables not centered** â†’ Adds `\centering` and proper placement
- **Figures not centered** â†’ Ensures proper figure alignment
- **Title formatting** â†’ Fixes alignment and formatting

### âœ… **Layout Problems**
- **Single-column code in two-column documents** â†’ Converts to proper two-column format
- **Column width mismatches** â†’ Fixes `\linewidth` vs `\columnwidth`
- **Missing float placement** â†’ Adds `[htbp]` parameters
- **Spanning issues** â†’ Converts to `table*` or `figure*` when needed

### âœ… **Structural Issues**
- **Inconsistent indentation** â†’ Normalizes spacing
- **Excessive blank lines** â†’ Cleans up document structure
- **Format compliance** â†’ Ensures IEEE, ACM, Springer standard compliance

---

## ğŸš€ How It Works

### **RAG-Based Multi-Stage Pipeline**

```
1. Detection â†’ 2. Retrieval â†’ 3. Generation â†’ 4. Validation
```

1. **Style Detection**: Analyzes LaTeX structure to find formatting and layout issues
2. **RAG Retrieval**: Retrieves correct examples from knowledge base using semantic search
3. **LLM Generation**: Generates context-aware fixes using Gemini with retrieved examples
4. **Validation**: Optionally validates fixes by LaTeX compilation

---

## ğŸ“¦ Installation

### **1. Clone or navigate to the directory**
```bash
cd "Rag latex fixer"
```

### **2. Install dependencies**
```bash
pip install -r requirements.txt
```

### **3. Set up API keys**
```bash
cp .env.example .env
# Edit .env and add your GEMINI_API_KEY
```

### **4. (Optional) Initialize embeddings**
The system will automatically create embeddings on first run, but you can pre-initialize:
```bash
python -c "from rag.knowledge_base import KnowledgeBaseManager; kb = KnowledgeBaseManager()"
```

---

## ğŸ® Usage

### **Command Line Interface**

```bash
# Basic usage - fix a LaTeX file
python cli.py input.tex

# Specify output file and format
python cli.py input.tex -o output.tex -f IEEE_two_column

# Get detailed report
python cli.py input.tex --report

# Skip compilation validation (faster)
python cli.py input.tex --no-validate

# Verbose mode
python cli.py input.tex -v
```

### **Python API**

```python
from pipeline import LatexFixerPipeline

# Initialize pipeline
pipeline = LatexFixerPipeline()

# Read LaTeX content
with open("document.tex", "r") as f:
    latex_content = f.read()

# Process document
report = pipeline.process_document(
    latex_content=latex_content,
    document_format="IEEE_two_column",
    validate_compilation=True
)

# Get results
print(f"Fixed {len(report.issues_fixed)} issues")
print(f"Success: {report.success}")

# Save fixed document
with open("document_fixed.tex", "w") as f:
    f.write(report.fixed_latex)
```

### **REST API**

```bash
# Start API server
python api.py

# Or use uvicorn
uvicorn api:app --host 0.0.0.0 --port 8000
```

**API Endpoints:**

```bash
# Fix LaTeX content
curl -X POST http://localhost:8000/fix \
  -H "Content-Type: application/json" \
  -d '{
    "latex_content": "\\documentclass{article}...",
    "document_format": "IEEE_two_column",
    "validate_compilation": false
  }'

# Upload and fix file
curl -X POST http://localhost:8000/fix/file \
  -F "file=@document.tex" \
  -F "document_format=IEEE_two_column"

# Analyze only (no fixing)
curl -X POST http://localhost:8000/analyze \
  -H "Content-Type: application/json" \
  -d '{"latex_content": "...", "document_format": "IEEE_two_column"}'

# Get supported formats
curl http://localhost:8000/formats
```

---

## ğŸ“š Knowledge Base Structure

The system uses a comprehensive knowledge base of correct LaTeX patterns:

```
knowledge_base/
â”œâ”€â”€ templates/                    # Correct templates by format
â”‚   â”œâ”€â”€ ieee_two_column/
â”‚   â”‚   â”œâ”€â”€ author_block_centered.tex
â”‚   â”‚   â”œâ”€â”€ table_in_two_column.tex
â”‚   â”‚   â”œâ”€â”€ figure_placement.tex
â”‚   â”‚   â””â”€â”€ complete_example.tex
â”‚   â”œâ”€â”€ acm_format/
â”‚   â””â”€â”€ springer_format/
â”‚
â”œâ”€â”€ fixes/                        # Fix patterns
â”‚   â”œâ”€â”€ centering_fixes.json
â”‚   â”œâ”€â”€ table_formatting.json
â”‚   â”œâ”€â”€ column_conversion.json
â”‚   â””â”€â”€ placement_fixes.json
â”‚
â”œâ”€â”€ patterns/                     # Correct pattern examples
â”‚   â”œâ”€â”€ correct_author_patterns.json
â”‚   â”œâ”€â”€ correct_table_patterns.json
â”‚   â””â”€â”€ correct_figure_patterns.json
â”‚
â””â”€â”€ embeddings/                   # Pre-computed embeddings
    â”œâ”€â”€ embeddings_cache.pkl
    â””â”€â”€ faiss_index.bin
```

---

## ğŸ”§ Configuration

Edit `.env` file or `config.py`:

```python
# LLM Configuration
PRIMARY_MODEL=gemini-1.5-pro      # Main model for generation
FALLBACK_MODEL=gemini-1.5-flash   # Faster fallback
EMBEDDING_MODEL=all-MiniLM-L6-v2  # For semantic search

# RAG Configuration
RETRIEVAL_TOP_K=5                 # Number of examples to retrieve
SIMILARITY_THRESHOLD=0.7          # Minimum similarity for retrieval

# System Configuration
MAX_RETRIES=3
COMPILATION_TIMEOUT=30
LOG_LEVEL=INFO
```

---

## ğŸ“Š Supported Formats

- âœ… **IEEE_two_column** (default)
- âœ… **ACM_format**
- âœ… **Springer_format**
- âœ… **generic** (general LaTeX best practices)

---

## ğŸ¯ Examples

### **Example 1: Fix Non-Centered Author**

**Input (from API):**
```latex
\author{John Doe}
\affiliation{MIT}
```

**Output (Fixed):**
```latex
\author{
  \IEEEauthorblockN{John Doe}
  \IEEEauthorblockA{MIT}
}
```

### **Example 2: Fix Table Not Centered**

**Input:**
```latex
\begin{table}
\begin{tabular}{|c|c|}
...
\end{tabular}
\end{table}
```

**Output:**
```latex
\begin{table}[htbp]
\centering
\begin{tabular}{|c|c|}
...
\end{tabular}
\end{table}
```

### **Example 3: Fix Column Width**

**Input (two-column document):**
```latex
\includegraphics[width=1.0\linewidth]{image.png}
```

**Output:**
```latex
\includegraphics[width=1.0\columnwidth]{image.png}
```

---

## ğŸ§ª Testing

```bash
# Run tests (when available)
pytest tests/

# Test specific component
python -c "from detectors.style_detector import StyleIssueDetector; detector = StyleIssueDetector()"
```

---

## ğŸ¤ Adding Custom Templates

To add templates for a new format:

1. Create directory: `knowledge_base/templates/your_format/`
2. Add `.tex` template files with correct examples
3. Regenerate embeddings:

```python
from rag.knowledge_base import KnowledgeBaseManager
kb = KnowledgeBaseManager()
kb.refresh_embeddings()
```

---

## ğŸ› Troubleshooting

### **Issue: "No LLM model available"**
- Solution: Set `GEMINI_API_KEY` in `.env` file

### **Issue: "Knowledge base not initialized"**
- Solution: Delete `embeddings_cache.pkl` and `faiss_index.bin`, restart

### **Issue: "Compilation failed"**
- Solution: Ensure `pdflatex` is installed and in PATH
- Or use `--no-validate` flag to skip compilation

### **Issue: Low quality fixes**
- Solution: Add more correct examples to `knowledge_base/templates/`
- Increase `RETRIEVAL_TOP_K` in config

---

## ğŸ“– Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LaTeX Input    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Style Detector         â”‚
â”‚  - Parse LaTeX          â”‚
â”‚  - Identify issues      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAG Retriever          â”‚
â”‚  - Semantic search      â”‚
â”‚  - Retrieve examples    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fix Generator (LLM)    â”‚
â”‚  - Generate fixes       â”‚
â”‚  - Use retrieved contextâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Validator              â”‚
â”‚  - Compile LaTeX        â”‚
â”‚  - Check compliance     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fixed LaTeX    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ How RAG Improves Fixing

**Traditional Approach:** Rules-based pattern matching â†’ brittle, limited

**RAG Approach:** 
1. **Retrieval**: Find similar correct examples from knowledge base
2. **Generation**: LLM generates fix guided by real examples
3. **Benefits**: Flexible, context-aware, learns from examples

---

## ğŸ“ License

MIT License - Feel free to use and modify!

---

## ğŸ™ Acknowledgments

- Built with Google Gemini for LLM generation
- FAISS for efficient vector search
- Sentence Transformers for embeddings

---

## ğŸ“§ Support

For issues or questions, please open an issue in the repository.
